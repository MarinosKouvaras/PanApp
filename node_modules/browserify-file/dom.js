// additional htmlparser
// then take the dom
// then
//
var htmlparser = require('htmlparser2');
var serialize = require('dom-serializer');

module.exports = function(file) {
    if (!/\.html/.test(file)) {
        return through();
    }

    var captured_dom = undefined;
    var handler = new htmlparser.DomHandler(function (err, dom) {
        if (err) {
            return console.error(err);
        }

        captured_dom = dom;

        return;
        var str = serialize(dom);
        console.log(str);
    });

    var parser = new htmlparser.Parser(handler);

    //var source = '';
    var stream = through(function(chunk, enc, cb) {
        //source += chunk.toString();
        parser.write(chunk.toString());
        cb();
    }, function(cb) {

        parser.end();

        // walk the dom and replace relevant entities

        var src = serialize(captured_dom);

        src = minify(src, {
            collapseWhitespace: true,
            removeComments: true,
        });

        this.push('module.exports=\'' + src.replace(/'/g, '\\\'') + '\';');
        cb();
    });

    return stream;
};

return;

